#
# SPDX-FileCopyrightText: Copyright 2025 Arm Limited and/or its affiliates <open-source-office@arm.com>
# SPDX-License-Identifier: Apache-2.0
#
name: Build ML SDK

on:
  workflow_call:
    inputs:
      changed_repo: { type: string }  # e.g., org/repo-a
      changed_sha:  { type: string }  # e.g., 40-char sha
      overrides_json: { type: string }

permissions:
  contents: read
  packages: read

env:
  MANIFEST_URL: https://github.com/${{ github.repository_owner }}/ai-ml-sdk-manifest.git
  REPO_DIR:     ${{ github.workspace }}/sdk
  INSTALL_DIR:  ${{ github.workspace }}/install
  CHANGED_REPO: ${{ inputs.changed_repo }}
  CHANGED_SHA:  ${{ inputs.changed_sha }}
  OVERRIDES:    ${{ inputs.overrides_json }}

jobs:
  build-linux:
    runs-on: ${{ matrix.platform }}
    strategy:
      matrix:
        include:
          - platform: ubuntu-24.04
            arch_tag: amd64
          - platform: ubuntu-24.04-arm
            arch_tag: arm64
      fail-fast: false

    container:
      image: ghcr.io/${{ github.repository_owner }}/ml-sdk-linux-${{ matrix.arch_tag }}:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: --user root

    steps:
      - &validate-inputs
        name: Validate workflow_call inputs
        shell: bash
        run: |
          repo="${{ inputs.changed_repo }}"
          sha="${{ inputs.changed_sha }}"
          overrides="${{ inputs.overrides_json }}"
          echo "repo=$repo sha=$sha overrides=$overrides"

          if [ -n "$repo" ] || [ -n "$sha" ]; then
            if [ -n "$repo" ] && [ -n "$sha" ]; then
              echo "Using changed_repo/changed_sha"
              exit 0
            else
              echo "ERROR: must provide BOTH changed_repo and changed_sha"
              exit 1
            fi
          fi

          if [ -n "$overrides" ]; then
            echo "Using overrides_json"
            exit 0
          fi

          echo "ERROR: must provide changed_repo+changed_sha OR overrides_json"
          exit 1

      - &checkout
        uses: actions/checkout@v4
      - name: Clone repositories and build
        run: .github/workflows/scripts/ci_build.sh

  build-macos:
    runs-on: macos-latest

    steps:
      - *validate-inputs
      - *checkout
      - &setup-python
        name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ./requirements.txt
          pip install -r ./tooling-requirements.txt

      - name: Install repo tool
        run: brew install repo

      - name: Install clang-format
        run: |
          pip install clang-format==14.0.6
          clang-format --version

      - name: Install xmlstarlet
        run: brew install xmlstarlet

      - name: Install MoltenVK
        run: |
          brew install molten-vk vulkan-tools vulkan-headers vulkan-loader
          echo "VK_DRIVER_FILES=$(brew --prefix molten-vk)/etc/vulkan/icd.d/MoltenVK_icd.json" >> $GITHUB_ENV
          sudo mkdir -p /usr/local/lib
          sudo ln -s /opt/homebrew/lib/libvulkan.dylib /usr/local/lib/libvulkan.dylib

      - name: Clone repositories and build
        run: .github/workflows/scripts/ci_build.sh

  build-windows:
    runs-on: windows-latest
    steps:
      - *validate-inputs
      - *checkout
      - *setup-python

      - name: Set up MSVC (Developer Command Prompt)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: amd64

      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1
        with:
          install_runtime: true
          install_lavapipe: true

      - name: Set Vulkan registry for lavapipe ICD
        shell: pwsh
        run: |
          Get-ChildItem "C:\lavapipe\share\vulkan\icd.d\"
          New-Item -Path "HKLM:\SOFTWARE\Khronos\Vulkan\Drivers" -Force | Out-Null
          New-ItemProperty `
              -Path "HKLM:\SOFTWARE\Khronos\Vulkan\Drivers" `
              -Name "C:\lavapipe\share\vulkan\icd.d\lvp_icd.x86_64.json" `
              -PropertyType DWord `
              -Value 0 `
              -Force

      - name: Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r ./requirements.txt

      - name: Install tools with Chocolatey
        shell: pwsh
        run: |
          choco install -y xmlstarlet
          xml.exe --version

      - name: git-repo tool
        shell: pwsh
        run: |
          git clone https://gerrit.googlesource.com/git-repo

      - name: Run CI build script
        shell: pwsh
        env:
          REPO: .\git-repo\repo
        run: |
          & "$env:GITHUB_WORKSPACE/.github/workflows/scripts/ci_build.ps1"
